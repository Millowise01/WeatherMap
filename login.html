<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Transformer Cycle Hub</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="page-login">
    <header class="header">
        <div class="header-container">
            <a href="index.html" class="logo">Transformer Cycle Hub</a>
            <nav>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="pickup.html">Schedule Pickup</a></li>
                    <li><a href="tutorials.html">Upcycling Tutorials</a></li>
                    <li><a href="rewards.html">Rewards</a></li>
                    <li><a href="contact.html">Contact Us</a></li>
                    <li><a href="dashboard.html" class="dashboard-link">Dashboard</a></li>
                    <li><a href="login.html" class="logout-link">Logout</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="auth-container">
            <div class="auth-tabs">
                <div class="auth-tab active" id="loginTab">Login</div>
                <div class="auth-tab" id="registerTab">Register</div>
            </div>
            
            <div class="auth-form active" id="loginForm">
                <h2>Welcome Back</h2>
                <div class="form-group">
                    <label for="loginEmail">Email Address:</label>
                    <input type="email" id="loginEmail" name="email" placeholder="you@example.com" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password:</label>
                    <input type="password" id="loginPassword" name="password" placeholder="Your password" required>
                </div>
                <button type="submit" class="btn" id="loginButton">Login</button>
                <div id="loginMessage" class="message"></div>
            </div>
            
            <div class="auth-form" id="registerForm">
                <h2>Create Account</h2>
                <div class="form-group">
                    <label for="fullName">Full Name:</label>
                    <input type="text" id="fullName" name="fullName" placeholder="John Doe" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email Address:</label>
                    <input type="email" id="registerEmail" name="email" placeholder="you@example.com" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password:</label>
                    <input type="password" id="registerPassword" name="password" placeholder="Create a strong password" required>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password:</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm your password" required>
                </div>
                <button type="submit" class="btn" id="registerButton">Register</button>
                <div id="registerMessage" class="message"></div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2025 Transformer Cycle Hub. All rights reserved.</p>
    </footer>

    <script src="data-manager.js"></script>
    <script src="socket-client.js"></script>
    <script src="data-manager.js"></script>
    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Tab switching functionality
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            loginTab.addEventListener('click', () => {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                loginForm.classList.add('active');
                registerForm.classList.remove('active');
            });
            
            registerTab.addEventListener('click', () => {
                registerTab.classList.add('active');
                loginTab.classList.remove('active');
                registerForm.classList.add('active');
                loginForm.classList.remove('active');
            });
            
            // Login functionality
            const loginButton = document.getElementById('loginButton');
            loginButton.addEventListener('click', async () => {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                if (!email || !password) {
                    window.displayMessage('Please fill in all fields.', 'error', 'loginMessage');
                    return;
                }
                
                window.displayMessage('Logging in...', 'info', 'loginMessage');
                
                try {
                    // Try to find user in localStorage first
                    const users = JSON.parse(localStorage.getItem('users')) || [];
                    const user = users.find(u => u.email === email);
                    
                    if (user) {
                        // Simple password check (in a real app, this would be hashed)
                        if (user.password === password) {
                            // Add login activity
                            if (!user.recentActivities) {
                                user.recentActivities = [];
                            }
                            
                            user.recentActivities.unshift({
                                date: new Date().toLocaleDateString(),
                                description: 'Logged in to the system'
                            });
                            
                            // Keep only the 10 most recent activities
                            if (user.recentActivities.length > 10) {
                                user.recentActivities = user.recentActivities.slice(0, 10);
                            }
                            
                            // Update user in localStorage
                            localStorage.setItem('users', JSON.stringify(users));
                            
                            // Login the user
                            window.loginUserSession(user);
                            window.displayMessage('Login successful! Redirecting...', 'success', 'loginMessage');
                            setTimeout(() => {
                                window.location.href = 'dashboard.html';
                            }, 1000);
                            return;
                        } else {
                            window.displayMessage('Invalid password. Please try again.', 'error', 'loginMessage');
                            return;
                        }
                    }
                    
                    // If not found in localStorage, try backend
                    try {
                        const response = await fetch(`${API_BASE_URL}/login`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email, password })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            window.loginUserSession(data.user);
                            window.displayMessage('Login successful! Redirecting...', 'success', 'loginMessage');
                            setTimeout(() => {
                                window.location.href = 'dashboard.html';
                            }, 1000);
                        } else {
                            const error = await response.json();
                            window.displayMessage(error.message || 'Login failed. Please check your credentials.', 'error', 'loginMessage');
                        }
                    } catch (error) {
                        console.log('Backend not available, using demo mode');
                        window.displayMessage('User not found. Please register first.', 'error', 'loginMessage');
                    }
                } catch (error) {
                    console.log('Login error:', error);
                    window.displayMessage('An error occurred during login.', 'error', 'loginMessage');
                }
            });
            
            // Register functionality
            const registerButton = document.getElementById('registerButton');
            registerButton.addEventListener('click', async () => {
                const fullName = document.getElementById('fullName').value;
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (!fullName || !email || !password || !confirmPassword) {
                    window.displayMessage('Please fill in all fields.', 'error', 'registerMessage');
                    return;
                }
                
                if (password !== confirmPassword) {
                    window.displayMessage('Passwords do not match.', 'error', 'registerMessage');
                    return;
                }
                
                if (password.length < 6) {
                    window.displayMessage('Password must be at least 6 characters long.', 'error', 'registerMessage');
                    return;
                }
                
                window.displayMessage('Creating your account...', 'info', 'registerMessage');
                
                try {
                    window.displayMessage('Creating your account...', 'info', 'registerMessage');
                    
                    // Create user object
                    const userData = {
                        fullName, 
                        email, 
                        password,
                        greenPoints: 0,
                        pickupCount: 0,
                        tutorialCount: 0,
                        wasteRecycled: { total: 0, plastic: 0, ewaste: 0, bottles: 0 },
                        recentActivities: [],
                        registeredAt: new Date().toLocaleString()
                    };
                    
                    // Add user to localStorage
                    const users = JSON.parse(localStorage.getItem('users')) || [];
                    
                    // Check if user already exists
                    if (users.some(u => u.email === email)) {
                        window.displayMessage('A user with this email already exists.', 'error', 'registerMessage');
                        return;
                    }
                    
                    // Add user
                    users.push(userData);
                    localStorage.setItem('users', JSON.stringify(users));
                    
                    // Add a notification message for the admin
                    const adminMessages = JSON.parse(localStorage.getItem('adminMessages')) || [];
                    const newMessage = {
                        id: 'UR' + Date.now(),
                        type: 'contact',
                        timestamp: new Date().toLocaleString(),
                        read: false,
                        name: fullName,
                        email: email,
                        subject: 'New User Registration',
                        message: `New user registered: ${fullName} (${email})`
                    };
                    
                    adminMessages.unshift(newMessage);
                    localStorage.setItem('adminMessages', JSON.stringify(adminMessages));
                    
                    // Notify admin dashboard
                    localStorage.setItem('newUserRegistered', Date.now().toString());
                    localStorage.setItem('newContactMessage', Date.now().toString());
                    
                    window.displayMessage('Registration successful! You can now log in.', 'success', 'registerMessage');
                    setTimeout(() => {
                        loginTab.click(); // Switch to login tab
                        localStorage.removeItem('newUserRegistered');
                        localStorage.removeItem('newContactMessage');
                    }, 2000);
                } catch (error) {
                    console.log('Registration error:', error);
                    window.displayMessage('An error occurred during registration.', 'error', 'registerMessage');
                }
            });
        });
    </script>
</body>
</html>